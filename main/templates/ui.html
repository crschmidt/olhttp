<html>
<head>
<script src="http://openlayers.org/dev/OpenLayers.js"></script>
<script src="http://maps.google.com/maps/api/js?v=3.5&amp;sensor=false"></script>
<link rel="stylesheet" href="http://openlayers.org/dev/theme/default/style.css" />
<link rel="stylesheet" href="/static/css/style.css" />
<script>
    LAYER_CONFIG = {
        'data': {
            'title': 'Base Data',
            'form': 'data_form',
            'type': 'Point',
	    'multi': true
        },
        'other': {
            'title': "Other",
            'form': 'other_form',
            'type': 'Polygon',
            'multi': false
        }    
    };    
    currentFeature = null;
    var map = null;
    function init() {
        map = new OpenLayers.Map("map", {'theme': null});
        var gmap = new OpenLayers.Layer.GoogleNG({type: google.maps.MapTypeId.HYBRID});
        map.addLayer(gmap);
        map.zoomToMaxExtent();
        for (var key in LAYER_CONFIG) {
            var layer_info = LAYER_CONFIG[key];

            var layer = new OpenLayers.Layer.Vector(layer_info['title'], {
                strategies: [new OpenLayers.Strategy.Fixed(), new OpenLayers.Strategy.Save()],
                protocol: new OpenLayers.Protocol.HTTP({
                    url: "/data/"+key,
                    format: new OpenLayers.Format.GeoJSON()
                }),
                layerKey: key
            }); 
            LAYER_CONFIG[key].layer = layer;
            map.addLayer(layer);
            layer.events.register('loadend', layer, register);
        }
        MyToolbar = OpenLayers.Class(OpenLayers.Control.Panel, {
            initialize: function(options) {
                OpenLayers.Control.Panel.prototype.initialize.apply(this, [options]);
                this.addControls( [ new OpenLayers.Control.Navigation() ]);
                for (var layer in LAYER_CONFIG) {
                    var info = LAYER_CONFIG[layer];
                    this.addControls( [
                        new OpenLayers.Control.DrawFeature(info.layer, OpenLayers.Handler[info.type], {'displayClass': 'olControlDrawFeature'+info.type, 'title': LAYER_CONFIG[layer].title, multi: info.multi || false})
                    ])
                    this.displayClass = 'myToolbar';
                }
            },
            CLASS_NAME: 'MyToolbar'
        });
        var toolbar = new MyToolbar();
        map.addControl(new MyToolbar());

    }
    function register() {
        this.events.register('featureadded', this, added);
        this.events.unregister('loadend', this, register);
    }
    function added(evt) {
        if (currentFeature) {
            currentFeature.layer.removeFeatures(currentFeature);
        }    
        currentFeature = evt.feature;
        var form = LAYER_CONFIG[this.layerKey].form;
        document.forms[form].title.value = "";
        document.forms[form].description.value = "";
        for (var key in LAYER_CONFIG) {
            document.getElementById(LAYER_CONFIG[key].form).parentNode.style.display = "none";
        }    
        document.getElementById(form).parentNode.style.display = "";
    }
    function save() {
        var layer = currentFeature.layer.layerKey;
        var form = LAYER_CONFIG[layer].form;
        currentFeature.attributes.title = document.forms[form].title.value;
        currentFeature.attributes.description = document.forms[form].description.value;
        currentFeature.layer.strategies[1].save([currentFeature]);
        document.getElementById(form).parentNode.style.display = "none";
        currentFeature = null;
    }
    function geocode(form) {
        var text = form.search_text.value;
        var geocoder = new google.maps.Geocoder(); 
        geocoder.geocode( {'address': text }, function(results, status) {
            if (results.length) {
                result = results[0];
                var ne = result.geometry.bounds.getNorthEast();
                var sw = result.geometry.bounds.getSouthWest();
                var bounds = [sw.lng(), sw.lat(), ne.lng(), ne.lat()];
                var bounds = OpenLayers.Bounds.fromArray(bounds);
                map.zoomToExtent(bounds.transform(
                    new OpenLayers.Projection("EPSG:4326"),
                    new OpenLayers.Projection("EPSG:900913")
                ));
            }
        });
    }
</script>
</head>
<body onload="init()">
<div id="details" style="float:right; width: 300px; display:none;">
  <form id="data_form" name="data_form" onsubmit="save(); return false">
    Title: <input type="text" value="" name="title" /><br />
    Description:<br />
    <textarea name="description"></textarea>
    <input type="submit" value="Save" />
  </form>
</div>
<div id="other_details" style="float:right; width: 300px; display:none;">
  <form id="other_form" name="other_form" onsubmit="save(); return false">
    Title: <input type="text" value="" name="title" /><br />
    Description:<br />
    <textarea name="description"></textarea>
    <input type="submit" value="Save" />
  </form>
</div>
<div id="map" style="width: 512px; height: 512px"></div><br />
<div id="geocoder">
<form name="geocoder" onsubmit="geocode(this); return false">
<input type="text" name="search_text" value="San Francisco" />
<input type="submit" value="Geocode" />
</form>
</body>
</html>
